#include "files.h"
#include "test.h"
#include "test_rt.h"


using namespace TINKER_NAMESPACE;


TEST_CASE("Vdw14-Trpcage", "[ff][evdw][lj][trpcage]")
{
   rc_flag = calc::xyz | calc::vmask;


   const char* kname = "test_vdw14.key";
   std::string k0 = trpcage_charmm19_key;
   k0 += "\nVDWTERM ONLY\n";
   const char* xname = "test_vdw14.xyz";
   const char* x0 = trpcage_charmm19_xyz;
   const char* pname = "charmm19.prm";
   const char* p0 = commit_11e84c69::charmm19_prm;


   const double eps_e = 0.0001;
   const double eps_g = 0.0001;
   const double eps_v = 0.001;
   const char* argv[] = {"dummy", xname};
   int argc = 2;


   SECTION("  - elj -- no pbc, no cutoff") {}


   SECTION("  - elj -- pbc, cutoff")
   {
      std::string k1 = k0 +
         "\nNEIGHBOR-LIST    0.5"
         "\nLIST-BUFFER      9.0"
         "\nA-AXIS            30"
         "\nB-AXIS            25"
         "\nC-AXIS            20"
         "\n";


      TestFile fxy(xname, x0);
      TestFile fke(kname, k1);
      TestFile fpr(pname, p0);


      const double ref_e = -75.9422;
      const double ref_v[][3] = {{-648.914, -118.602, 31.392},
                                 {-118.602, -489.997, 29.829},
                                 {31.392, 29.829, -460.902}};
      const int ref_count = 7611;
      const double ref_g[][3] = {
         {-2.2164, -0.7234, -1.6869},   {-10.1319, -2.4701, 1.2680},
         {5.0046, 0.5482, 1.3207},      {13.8546, 2.2818, 4.3928},
         {-0.1064, 0.1347, 0.1492},     {-0.1040, 0.1800, 0.1592},
         {-0.0267, 0.1056, 0.1362},     {0.4284, 0.1657, -0.1696},
         {0.7676, 0.6395, 1.0704},      {10.2842, 2.0886, -0.1420},
         {-0.3111, 0.0133, -0.1921},    {-0.0176, 0.0221, -0.0637},
         {-0.0420, -0.0131, 0.0208},    {0.4029, 2.2051, 0.7303},
         {-2.8770, -3.0140, 0.9725},    {-13.7846, -4.6079, 0.7474},
         {-0.5527, -1.5826, 7.8415},    {1.0282, 0.6615, 0.1475},
         {-0.3715, -0.1666, 0.2631},    {-1.8493, -5.8499, 0.1802},
         {3.0889, -3.6117, -0.6172},    {-0.1005, 0.6834, -0.2405},
         {-2.5080, 1.5875, -2.1174},    {1.5359, -0.1195, -4.5871},
         {0.4414, 1.0460, -3.7952},     {-0.3191, -11.0238, -3.0084},
         {0.2163, 0.7015, -0.1474},     {-0.2809, -0.0992, 0.1100},
         {9.2727, -1.8561, 7.8910},     {7.1618, 5.6986, -2.8074},
         {0.3712, -10.2762, 7.3166},    {0.5440, 7.7609, -8.4506},
         {-8.3945, -8.7248, 0.4016},    {-8.2258, -1.0892, -8.8946},
         {0.5298, -1.1042, -0.3092},    {-0.2879, 0.2581, 0.0075},
         {-3.8380, 1.5709, -2.2684},    {1.7740, 2.9981, 2.3811},
         {2.7063, 3.8526, 2.4079},      {7.1812, -4.2263, -5.0605},
         {-0.8609, -0.1197, -0.3865},   {1.0757, 2.2374, -2.5554},
         {3.6870, 1.5636, -1.7723},     {2.7113, 1.5189, 0.5956},
         {2.0283, -2.2248, -3.2507},    {0.5219, 2.0708, 2.8476},
         {-1.7172, -3.5993, 2.9187},    {-3.2700, -1.1798, 3.8772},
         {1.9138, 4.0640, 3.8890},      {-2.0587, 1.8374, -0.1766},
         {0.0732, -0.1973, -0.4031},    {0.8707, -0.4480, 0.5633},
         {0.5267, 0.0871, 0.6281},      {3.7160, -4.3344, -0.1370},
         {0.2814, 0.2360, 0.1205},      {0.0099, 0.0217, -0.0637},
         {-0.0637, -0.0366, -0.0416},   {-3.2581, -0.5651, 0.5125},
         {-1.9839, -2.8229, -3.8719},   {1.5296, 3.7383, 0.0034},
         {-5.9875, -1.7030, 6.0722},    {-0.0185, 0.9456, -0.4329},
         {-0.1215, 1.4975, 1.0204},     {-3.1902, -2.7405, -0.3882},
         {-0.0031, -0.2755, -0.9480},   {4.3191, -1.8089, 8.6858},
         {2.0626, 1.1380, -0.6755},     {-7.6311, 0.6236, 14.3690},
         {10.1965, -0.5748, 1.9787},    {-11.8018, -6.9841, -0.5524},
         {3.9867, 2.1539, -10.2709},    {-3.0713, -4.2017, -9.0012},
         {8.9766, -0.9022, -0.5028},    {-1.4541, 1.3437, -0.7712},
         {4.5496, 1.6097, -1.6994},     {4.2564, 0.4866, -7.0587},
         {2.8942, -7.3298, -13.3921},   {-4.0424, 6.5316, 2.2744},
         {-0.3333, -0.3636, -0.2753},   {0.2933, 2.4976, -0.8547},
         {0.2817, 1.5513, 0.7701},      {1.2047, 1.1613, -2.3921},
         {0.9794, 0.8230, -1.2446},     {3.3966, 0.6967, 3.8238},
         {-2.7489, 6.1146, 0.5687},     {2.5827, 2.1783, -1.5333},
         {-5.2188, 4.7827, -1.1892},    {0.0800, -0.6153, 0.3820},
         {4.7281, 0.0818, 3.2952},      {5.3757, -0.8374, 4.4280},
         {11.5749, 3.7712, 1.5512},     {-1.1730, 1.5600, 0.1748},
         {-0.0349, -0.0502, -0.1086},   {-0.1088, 0.0522, -0.1090},
         {0.0260, -0.0945, -0.1203},    {-2.0847, 0.9106, 4.9337},
         {-4.8335, -1.1902, -3.1371},   {1.1545, -0.2698, -0.7977},
         {98.0660, 57.9110, -61.0547},  {0.0607, -0.2317, 0.0111},
         {1.3703, -1.5175, 0.7714},     {-0.3506, -0.4142, -0.4853},
         {-15.0512, -3.3838, 0.9625},   {-0.9020, -0.4775, -1.1090},
         {-3.5734, 2.5923, 0.0149},     {0.0488, -0.8733, -3.9410},
         {2.1754, 3.4427, 0.5241},      {1.7739, 11.7414, -1.5246},
         {-6.8603, 2.8165, 4.4077},     {0.0134, -2.0730, -1.3332},
         {4.6285, 3.8544, 5.7936},      {-0.3064, -5.9778, 3.3960},
         {6.3692, -2.1176, 7.8289},     {0.1206, -0.0692, 0.0270},
         {1.2702, -1.0129, 0.1311},     {-3.3381, -0.4484, -4.3424},
         {-8.0209, -0.1080, -7.6984},   {-1.4746, -4.7346, 0.6907},
         {0.5215, -0.3216, -0.0785},    {-0.1097, 0.3752, 0.2766},
         {-3.8793, 2.4231, -4.9964},    {-2.5769, 2.0113, -1.2772},
         {1.7273, 4.1809, 0.0190},      {0.5762, 1.0705, 0.3637},
         {-1.7960, 3.1622, 1.7322},     {-0.6945, -0.3201, -0.0609},
         {0.5397, -0.2686, -4.4058},    {0.0575, 0.6424, -0.3884},
         {0.0361, -0.0798, 0.0530},     {3.0223, 2.6996, 2.9573},
         {1.6540, -3.9686, 2.7224},     {1.2319, 2.5549, -0.5045},
         {3.6040, 2.7639, 4.1621},      {0.6466, 0.4753, 2.6037},
         {-2.6864, -2.2174, -2.0986},   {-7.3210, -5.0406, 4.5259},
         {-89.4161, -49.1468, 60.4433}, {-1.7303, 0.3310, 1.1883},
         {-4.0663, -1.9192, -2.4672},   {-3.3498, -2.9918, -0.6629},
         {-3.2942, 2.2410, 1.5740},     {-0.0538, -0.1952, -0.0782},
         {-2.3368, -2.7033, 0.3217},    {4.9764, 3.8990, -1.6356},
         {-3.4690, 2.0952, -0.1840},    {-10.1458, 6.3251, -3.7385},
         {0.2347, -0.0918, -0.0387},    {1.4105, -0.7155, -0.9389},
         {5.2703, 2.6790, 4.4210},      {1.5028, 0.0483, -3.4667},
         {0.2302, 0.4931, -0.0688},     {0.8923, 1.3315, 1.1714},
         {-1.2989, 1.1141, 3.4130},     {0.2827, -0.2033, -0.8727},
         {0.1152, 0.0403, 0.0461},      {-0.1718, 0.0434, 0.2392},
         {0.0681, 0.1215, -0.1526},     {0.1191, -0.1953, -0.2149},
         {0.0385, -0.1585, -0.1124},    {-2.5899, 1.5642, -0.0689},
         {-3.6237, -3.7692, 4.5169},    {1.0153, -2.0233, -1.7913},
         {1.7714, 1.2664, 5.3244},      {-3.8968, -0.7671, 4.6320},
         {-1.5865, -0.7425, 0.8589},    {-2.4031, -5.9633, -0.3625},
         {0.0380, 2.8054, -0.1753},     {-3.5981, -6.4705, -8.2678},
         {3.2007, -2.1180, -0.4318},    {-4.3545, -2.9885, 0.0202},
         {-1.4727, -1.3504, -1.8508},   {-0.3440, 1.3187, -2.0310},
         {5.9243, -0.2389, -9.7631},    {-0.8509, 1.0687, 0.2025},
         {5.3733, -0.2768, 2.3440},     {1.3701, -2.8251, -0.6849},
         {1.7661, -1.3146, -4.7080},    {-1.3811, 1.1651, 1.2168},
         {-1.7421, 5.7911, 2.7910},     {6.6776, -2.7290, 5.1516},
         {-0.4653, 3.3768, -0.4683},    {-0.7487, -3.1300, 0.7180},
         {0.4081, -1.4233, 0.1184},     {4.6940, -1.0748, 3.4169},
         {0.1153, -0.0190, -0.0371},    {-3.7532, -0.1327, -2.6158},
         {-0.5147, -0.5606, -0.4352},   {-0.3874, 0.0934, -0.2250},
         {-0.0650, 0.9019, 0.2167}};


      test_begin_with_args(argc, argv);
      initialize();


      energy(calc::v0);
      COMPARE_REALS(esum, ref_e, eps_e);


      energy(calc::v1);
      COMPARE_REALS(esum, ref_e, eps_e);
      COMPARE_GRADIENT_(ref_g, eps_g);
      for (int i = 0; i < 3; ++i)
         for (int j = 0; j < 3; ++j)
            COMPARE_REALS(vir[i * 3 + j], ref_v[i][j], eps_v);


      energy(calc::v3);
      COMPARE_REALS(esum, ref_e, eps_e);
      COMPARE_INTS(count_reduce(nev), ref_count);


      energy(calc::v4);
      COMPARE_REALS(esum, ref_e, eps_e);
      COMPARE_GRADIENT_(ref_g, eps_g);


      energy(calc::v5);
      COMPARE_GRADIENT_(ref_g, eps_g);


      energy(calc::v6);
      COMPARE_GRADIENT_(ref_g, eps_g);
      for (int i = 0; i < 3; ++i)
         for (int j = 0; j < 3; ++j)
            COMPARE_REALS(vir[i * 3 + j], ref_v[i][j], eps_v);


      finish();
      test_end();
   }
}
