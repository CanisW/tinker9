#include "files.h"
#include "test/ff.h"
#include "test/rt.h"
#include "test/test.h"

using namespace TINKER_NAMESPACE;
using namespace test;

static const char* boned_term_only = R"**(
vdwterm        none
multipoleterm  none
polarizeterm   none
)**";

static int usage = calc::xyz | calc::vmask;

static const double ref_g_bonded_trpcage[][3] = {
    {-8.1695, 0.3312, -10.8960},   {4.3225, -2.3232, -4.7012},
    {-2.6058, 4.0082, 15.1218},    {-6.4836, -1.0473, -11.6934},
    {5.2269, 2.3780, 2.3906},      {3.1576, -2.1641, 0.8450},
    {3.7703, 0.9275, -0.7707},     {-1.3150, 0.9650, -0.3569},
    {-1.7986, -0.0072, -2.1243},   {-5.1933, -10.6708, 11.0220},
    {-1.0800, 3.1148, -5.2193},    {-1.0660, 2.3074, -3.8628},
    {-0.3240, -2.9815, 3.6359},    {-1.8940, -2.4565, -0.0277},
    {-1.9777, 1.6543, 5.6947},     {1.9247, 0.7423, 0.5350},
    {1.6339, 3.0009, -21.2076},    {-6.4200, 0.0051, 5.0334},
    {18.2945, -7.4521, 5.4053},    {-12.1540, 2.1963, -2.9802},
    {3.2008, -0.3015, 8.4244},     {1.6234, -2.3355, -1.7763},
    {-3.2564, -1.5941, -5.1988},   {3.0425, 1.8619, 0.9338},
    {3.6874, 0.4222, -2.6411},     {0.4946, 0.9588, 4.2655},
    {-2.2251, 1.7439, -1.7780},    {-2.5801, 0.0615, -2.6438},
    {3.1995, 0.0480, -0.1152},     {2.1362, 0.9905, -2.5691},
    {2.4461, 2.2521, -2.3056},     {3.0111, 0.8351, -1.3393},
    {-0.1622, 0.4318, 3.2528},     {1.8827, 3.6594, 2.7011},
    {-0.0756, 2.0392, 3.7270},     {-16.0675, -0.6067, -5.5245},
    {6.6221, 1.1654, -4.3081},     {-6.5232, 1.8520, 16.6243},
    {2.8424, -0.8139, -8.8557},    {5.0384, 0.2500, 5.3638},
    {-2.6374, 1.8461, 0.5749},     {-3.5962, -0.9144, -3.1251},
    {-3.6090, -5.1535, -3.6628},   {-5.3572, 3.4578, -0.3627},
    {5.8942, -3.7739, -0.6348},    {-4.9713, 3.1442, 3.5022},
    {5.9866, -2.7728, -0.7864},    {0.9273, -2.3430, 6.7366},
    {0.1671, 0.1415, -0.0600},     {-1.2659, -1.9540, -1.8351},
    {-0.9648, -2.5804, -1.4133},   {-1.9239, 1.2163, 1.6211},
    {2.0536, -0.8432, 0.7438},     {-0.5501, 0.7134, 0.4291},
    {1.1636, -0.3644, -0.3450},    {-0.4036, -0.5721, 4.1407},
    {5.3571, -2.0110, -14.9709},   {-6.9344, -3.1971, 4.2590},
    {13.8731, -3.8594, 3.1109},    {-6.1098, -0.5696, -0.8745},
    {2.2399, -0.5782, 5.4311},     {-0.3452, -3.7373, -2.7359},
    {-0.1111, 0.0837, 0.1600},     {3.4658, 2.1338, -2.1109},
    {-3.3492, 7.7558, -3.6735},    {4.1386, 0.3996, 0.3667},
    {0.2484, 1.0953, -3.3292},     {3.4973, 0.1488, 0.2828},
    {2.7063, 0.5190, 1.9649},      {-0.7844, 3.1215, 1.2371},
    {-3.5340, 1.1653, 0.4271},     {-2.4694, 1.9344, 0.5684},
    {1.3234, 1.5620, -0.6151},     {2.3678, 1.8266, -0.5343},
    {1.2017, 1.0794, -0.9328},     {-14.4188, -0.2417, -1.2149},
    {6.1382, 2.5740, -4.3541},     {-7.5736, 1.5613, 12.9980},
    {4.6535, -0.0886, -6.8713},    {3.3731, 0.3471, 3.8075},
    {-3.1211, 2.1276, -0.7278},    {0.1217, -0.8180, -0.5271},
    {-3.1839, -0.7659, -2.5448},   {0.1845, 0.1622, 7.2083},
    {2.8098, -1.5156, -3.6077},    {-4.8985, -5.1472, -1.6423},
    {0.0306, -0.4890, -1.3129},    {-2.0030, 0.8607, 0.1915},
    {-0.8968, -2.2016, 2.7341},    {-0.4810, -1.0967, 3.5694},
    {0.9495, -3.9781, 0.2006},     {0.3663, 0.5292, 2.1904},
    {4.1965, -0.9729, -12.9952},   {-5.5086, -1.2734, 6.0399},
    {13.2842, 0.2246, -1.4257},    {-6.5264, -0.2029, -0.1037},
    {2.4248, -0.1379, 5.3160},     {1.4039, -2.0463, -2.5611},
    {0.7200, 4.8232, -5.6977},     {2.0466, 3.8935, -3.8476},
    {1.5238, -0.2227, 1.8834},     {-1.2585, -4.3021, -5.0348},
    {-0.3692, -1.3553, -0.4323},   {7.3359, -3.4858, -7.9905},
    {-7.8077, -1.0044, 1.2110},    {7.4534, 3.5965, 1.6982},
    {-7.0342, 3.0971, 8.8985},     {2.8530, 5.3930, 6.4452},
    {-1.4169, 1.2345, -1.8119},    {-0.5591, 1.8754, -1.2003},
    {0.5022, -0.9280, -1.6277},    {0.7553, -0.4555, -0.6507},
    {-1.0424, 0.1539, 1.6855},     {1.3957, 0.7453, 0.1034},
    {-0.2277, 0.4735, 0.3822},     {0.4070, 0.1739, 0.6363},
    {-13.6599, -0.2455, -0.0807},  {6.9258, 1.6130, -5.2642},
    {-8.0270, 1.4888, 10.7738},    {4.2412, 0.9012, -5.6269},
    {2.8287, 0.9247, 2.6982},      {-3.3492, 1.8111, -0.8078},
    {-2.1640, -0.6127, -1.7570},   {-0.5352, -0.8546, 1.5456},
    {-3.8058, -1.9060, 3.2482},    {3.9724, -0.2330, 3.1610},
    {-0.7634, -0.6534, -3.1815},   {-1.3166, -0.1026, -3.7509},
    {-1.0019, -0.3268, 2.6046},    {-3.0112, -1.6328, 0.8055},
    {-2.6620, -2.5531, 0.6216},    {-2.5518, -1.6961, 1.5648},
    {2.9529, -0.5707, 0.9596},     {2.1714, -3.5345, 1.8399},
    {3.2028, -1.6994, 0.8796},     {4.8418, -2.2227, -9.9326},
    {-7.4379, -0.3947, 5.6766},    {11.3667, -5.0025, 5.1419},
    {-7.8357, 1.1390, -2.2698},    {1.1768, 1.4001, 3.5183},
    {-0.3638, -2.5407, -3.6501},   {5.5990, 2.2338, -2.0019},
    {0.6691, 3.0797, -5.3993},     {2.3712, 4.0246, -3.5469},
    {0.1788, 1.3698, 0.0301},      {10.0729, 20.4653, 5.7984},
    {-3.3625, -0.7037, -1.8588},   {-0.9392, -0.5143, -2.4711},
    {1.9834, -0.8572, -1.1919},    {1.3554, -0.8452, -1.8146},
    {-3.2884, -0.2392, 0.0156},    {-1.8836, 1.7291, -0.2699},
    {1.1810, 0.6334, 0.1482},      {1.9744, -0.3386, 2.7155},
    {-2.8742, -4.1431, 2.6468},    {-0.0491, -7.0213, -2.2739},
    {-0.6205, -3.2678, 2.7770},    {-7.4263, -1.7092, -4.9670},
    {5.9047, 0.8587, -5.8798},     {-14.0284, -28.4113, 25.6901},
    {8.4808, 19.1119, -11.0832},   {0.9771, 0.7528, 0.7315},
    {-3.4251, -2.5258, 0.5936},    {-3.1454, 3.0814, 4.3809},
    {16.6552, -36.1005, -14.3939}, {-12.3607, 13.2949, 6.6193},
    {1.8469, 7.8550, 8.2894},      {2.1638, -1.2773, 0.2490},
    {1.5811, -2.9560, 1.3549},     {-7.4450, 39.5809, -14.9944},
    {-1.8852, -4.5128, -0.4617},   {4.0237, -4.7009, -4.9145},
    {-4.0135, 5.6902, 3.3225},     {1.9704, -4.5612, -0.7432},
    {0.5435, 1.1166, 4.2291},      {1.7189, -0.2943, 1.2066},
    {-1.9431, 5.5179, 10.1571},    {1.1498, -5.1803, -6.3557},
    {-1.8778, -11.7157, -3.1375},  {3.1201, 4.1024, -0.2063},
    {3.3834, -7.8070, 2.5387},     {-3.6094, -4.4795, -4.4820},
    {0.4670, 0.0020, 0.0095},      {0.0051, 8.0015, -3.4977},
    {0.2544, -9.7222, 0.8845},     {5.4398, 7.0646, -5.6191},
    {0.7382, -0.6571, 2.9762},     {0.8064, 4.4796, -1.8588},
    {-0.7117, 4.3020, 7.1643},     {-2.7739, 2.0172, 2.1747},
    {-1.8716, 4.6774, 6.6834},     {1.0467, -0.5795, 1.8463},
    {2.0304, -2.0742, 3.2459},     {-1.1039, 2.9662, 1.0838},
    {-0.5344, 1.4493, 0.5584},     {-2.2780, 2.3046, -0.7076},
    {-1.6403, -1.7548, -0.3273},   {-8.5119, -10.1520, -2.4793},
    {-0.6290, 7.6834, 2.7345},     {3.8858, -16.4785, -3.9689},
    {-0.0603, 9.1438, 1.5236},     {3.5294, -0.5103, 2.2696},
    {-2.1649, -1.5642, 0.8947},    {0.9239, -1.2113, -5.1475},
    {1.5098, -3.4986, -1.2121},    {-0.2996, 0.4335, -2.1346},
    {-1.6953, -0.3844, -1.2373},   {1.4882, -2.7398, -1.0629},
    {-4.8906, 13.7943, 2.3727},    {0.2877, -8.2496, -3.2740},
    {3.2053, 12.2329, 3.3465},     {0.8307, -6.9675, -1.6141},
    {4.1377, -0.5317, -2.5108},    {-0.2439, 1.4890, -1.8217},
    {-3.7670, 0.8661, 5.7629},     {0.0373, 4.9547, 3.9594},
    {-1.7751, -0.8031, 1.5581},    {-0.7253, 0.9851, 1.0795},
    {1.1661, 1.6148, 1.9512},      {1.8190, -14.5614, -9.1459},
    {1.5255, 5.3304, 2.7033},      {-1.2715, -11.1544, -8.6077},
    {3.1147, 4.6786, 4.7526},      {1.4423, 0.9418, 2.3848},
    {-2.8822, -1.9673, -1.3159},   {-1.0381, -0.5456, -1.8640},
    {-3.4663, 11.0991, 0.2789},    {-1.6024, -9.2139, -4.5635},
    {1.4394, 2.9872, -0.6720},     {-2.5288, -3.0427, -3.2798},
    {3.4489, -2.1294, 0.0999},     {-5.0613, 3.3368, 0.0836},
    {1.2411, 3.8421, 5.3049},      {-5.2918, 3.6007, 9.3836},
    {3.9764, -3.1315, 0.8473},     {-7.6098, 1.3627, 8.6151},
    {7.6898, -5.5684, -4.7759},    {1.7530, 3.0079, 4.3826},
    {-3.1673, 3.6927, 5.7375},     {-4.1369, -1.7277, -2.5617},
    {-3.1861, 0.9213, -0.2650},    {1.1876, 2.5365, -1.2460},
    {0.7040, 2.0790, 1.6229},      {1.5582, -1.6238, 1.6095},
    {-1.9640, -2.9618, -2.6829},   {-0.8865, -1.3712, -3.3113},
    {5.9884, -2.0116, -1.1890},    {3.5886, -1.0413, 1.0187},
    {-3.4339, 1.2404, 0.7007},     {0.5505, 2.0548, 1.9471},
    {1.6487, -1.2453, -10.8463},   {-3.1317, 2.8158, 8.4009},
    {13.8170, -11.4321, -8.3437},  {-7.7467, 6.8249, 5.6542},
    {0.5097, 3.0673, -5.8245},     {4.5995, 3.8496, -2.5621},
    {-2.1470, 1.8949, -1.1095},    {2.8190, 3.3567, -1.6065},
    {2.6370, -0.8963, 1.7151},     {4.5554, -0.2643, 2.8404},
    {2.3092, 1.9015, -2.9160},     {1.6220, 1.0656, -1.1191},
    {0.6778, 2.5212, -1.3670},     {-1.2900, 1.9762, 0.7215},
    {-6.5815, -1.3480, -0.0712},   {6.2338, 5.6101, 0.1538},
    {10.7536, -8.2104, 4.4877},    {-7.0024, 3.0777, -0.3122},
    {-3.3173, -1.1111, -3.8839},   {-0.9620, -5.7327, -2.4115},
    {-1.4976, -0.1616, -2.9175},   {0.2454, -4.7453, -3.0052},
    {2.2055, -1.0626, 2.1838},     {4.4308, -2.1533, 2.9518},
    {-1.6518, -3.3003, -1.7489},   {-0.5948, -1.7908, -0.7833},
    {-1.2958, -1.3146, -1.7557},   {1.3650, 1.2825, -1.2749},
    {-6.5187, 9.3509, -0.3146},    {3.3344, -9.1644, -5.5621},
    {15.5656, 7.8787, 1.7094},     {-10.5542, -1.1068, 0.5687},
    {-0.4133, 3.2417, 2.1713},     {-7.3724, 2.0660, 9.2465},
    {-4.3676, 1.6103, -1.7261},    {-4.4350, -0.6313, 3.8534},
    {2.7889, -0.9080, 2.1924},     {3.4565, -2.0623, 2.7289},
    {-1.8264, -0.0272, 2.7893},    {-0.7645, -0.1190, 1.0300},
    {-1.5070, -0.8749, 1.8183},    {0.1609, -1.8662, -1.3631},
    {-9.9369, -15.1155, -4.7538},  {-9.2991, 4.2657, 3.0787},
    {11.5127, 3.6896, 1.9558},     {-6.8401, 6.4990, 4.4535},
    {9.9348, 0.7417, 2.6281},      {0.4060, -0.8888, 1.0646},
    {5.3046, 1.4780, -0.2623},     {7.9880, -10.6345, -15.5350},
    {-0.0523, -0.0443, -2.4827},   {1.1958, -0.6540, -1.5907},
    {-5.3282, 5.1295, 8.1689},     {4.3380, 2.9096, 2.8671}};
TEST_CASE("Bonded-Trpcage", "[ff][ebonded][trpcage]") {
  const char* k = "test_trpcage.key";
  const char* x1 = "test_trpcage.xyz";
  const char* p = "amoebapro13.prm";

  std::string k0 = trpcage_key;
  k0 += boned_term_only;
  file fke(k, k0);

  file fx1(x1, trpcage_xyz);
  file fpr(p, amoebapro13_prm);

  const char* argv[] = {"dummy", x1};
  int argc = 2;
  test_begin_1_xyz(argc, argv);
  use_data = usage;
  initialize();

  const double eps_e = 0.0001;
  const double ref_e = 103.9243;
  const int ref_bond_count = 310;
  const double eps_g = test_get_eps2(0.005, 0.0001);
  const double eps_v = test_get_eps2(0.002, 0.001);
  const double ref_v[][3] = {{938.362, 105.806, 258.684},
                             {105.806, 698.628, 26.980},
                             {258.684, 26.980, 1106.334}};

  COMPARE_BONDED_FORCE(energy_potential, esum, ref_e, eps_e, nbond,
                       ref_bond_count, gx, gy, gz, ref_g_bonded_trpcage, eps_g,
                       vir, ref_v, eps_v);

  finish();
  test_end();
}
