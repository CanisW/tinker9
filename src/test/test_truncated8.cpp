#include "files.h"
#include "test.h"
#include "test_rt.h"


using namespace tinker;


TEST_CASE("Truncated-Octahedron", "[ff][pbc][arbox]")
{
   rc_flag = calc::xyz | calc::vmask;


   const char* kname = "test_t8.key";
   std::string k0 = R"**(
parameters  amoeba09

neighbor-list
list-buffer      0.5
cutoff           7.0

vdwterm         only
octahedron
)**";
   const char* xname = "test_t8.xyz";
   const char* x0 = R"**(   216  Argon Atoms at 94 K
    21.857000   21.857000   21.857000   90.000000   90.000000   90.000000
     1  Ar     3.730970    1.353154    8.607041     3
     2  Ar     4.776614   -5.836419    4.718943     3
     3  Ar    -3.290084   10.611616    0.547101     3
     4  Ar    -4.153997  -10.021155   -2.193684     3
     5  Ar     3.450487   -3.621491    2.761234     3
     6  Ar     2.072715   -2.032567    5.097523     3
     7  Ar     0.847897    9.698771   -3.292523     3
     8  Ar    -1.208179   -7.785908   -5.163866     3
     9  Ar     5.653246   -2.601201    4.714353     3
    10  Ar    -1.234715   -9.905061   -2.904016     3
    11  Ar     6.620843    2.195639    5.829467     3
    12  Ar     1.452978   -8.961340   -4.172321     3
    13  Ar     0.725183   -2.627896    1.557383     3
    14  Ar    -0.758925   -4.790209   -3.186590     3
    15  Ar    -2.535063   -7.143714   -2.287549     3
    16  Ar     2.640239   -4.697646   -0.229358     3
    17  Ar     0.574699   -7.383168   -1.718489     3
    18  Ar     2.965207   -7.104675   -6.092783     3
    19  Ar    -3.025220   -9.332040    3.223523     3
    20  Ar    -1.127958   -2.271575    5.127826     3
    21  Ar    -0.634425   -7.373935    3.171434     3
    22  Ar    -3.893035   -6.368254    3.289264     3
    23  Ar    -0.755222   -8.971149    5.861277     3
    24  Ar    -0.569364   -1.191704    7.939966     3
    25  Ar     2.877410    7.334819    5.253152     3
    26  Ar    -8.989076   -2.074297   -3.067110     3
    27  Ar     4.726464    4.819426    5.398243     3
    28  Ar    -5.533220   -7.050184   -2.557548     3
    29  Ar     0.358918    5.918712    6.283803     3
    30  Ar     2.433135    3.558574    6.664961     3
    31  Ar     8.100464   -0.339218   -4.838229     3
    32  Ar     7.019609    4.734879   -2.828826     3
    33  Ar    -0.568394   -6.843976    8.347897     3
    34  Ar     0.642388   -4.112571    6.936429     3
    35  Ar     9.915032    2.304010    0.221931     3
    36  Ar    -9.991134    4.712918    0.691854     3
    37  Ar     2.244082   10.146683    1.412351     3
    38  Ar    -2.261443    0.973803    9.383444     3
    39  Ar     5.553201    7.459018   -3.180571     3
    40  Ar    -3.760378   -1.868478    9.956598     3
    41  Ar    -5.414704    0.746117    9.787262     3
    42  Ar     7.022827   -7.588063   -0.174140     3
    43  Ar     1.813754   -9.468009    3.918941     3
    44  Ar    -4.340444    3.307126   -7.976148     3
    45  Ar    -5.975167    1.750935   -5.942236     3
    46  Ar     4.405127   -9.519491    1.867731     3
    47  Ar    -2.008045    1.881946   -6.607189     3
    48  Ar    -0.844020    3.746711   10.363342     3
    49  Ar    -2.055539    8.827753   -2.022524     3
    50  Ar     0.820787    5.097475    0.106728     3
    51  Ar    -0.365278    7.100346   -8.579141     3
    52  Ar    -7.006284   -0.292337    7.164567     3
    53  Ar    -3.384200   -0.842437    3.517408     3
    54  Ar     2.776120    7.640796   -4.409885     3
    55  Ar     4.883631   -0.992272   -5.484850     3
    56  Ar    -0.351701   10.731230   -0.287591     3
    57  Ar    -4.483193    6.418960    3.354663     3
    58  Ar    -7.584005    5.613883    2.316528     3
    59  Ar     5.021374    0.736268   -8.074715     3
    60  Ar     7.830047   -0.742669    6.077044     3
    61  Ar     3.859247    4.048854    0.696856     3
    62  Ar     6.009243    3.487883    2.943785     3
    63  Ar     0.248050    3.034824    4.531712     3
    64  Ar     0.155249    0.016514    3.417512     3
    65  Ar     2.321339    4.982404    3.348046     3
    66  Ar     4.490646   -0.158413    6.088112     3
    67  Ar     1.077399   -2.587778   -1.860570     3
    68  Ar     1.176089    2.710359   -7.073483     3
    69  Ar     1.402990   -0.089196    0.053841     3
    70  Ar     4.599068    2.890425   -2.419312     3
    71  Ar    -0.815577    0.194920   -1.993166     3
    72  Ar     0.241463    0.870977   -4.774408     3
    73  Ar    -8.005329    2.006130    1.525948     3
    74  Ar    -6.462382   -2.299379   -1.138544     3
    75  Ar    -6.472300    0.954756   -1.186490     3
    76  Ar   -10.615609    0.030924    1.987557     3
    77  Ar    -8.621280   -3.300690    0.871794     3
    78  Ar     9.682101   -2.557697   -3.261649     3
    79  Ar    -3.318141   -5.710312   -4.959621     3
    80  Ar    -1.970601   -3.878623    2.621182     3
    81  Ar    -1.662032   -3.088578   -0.621108     3
    82  Ar    -0.130646   -5.606037    0.669007     3
    83  Ar    -4.342710   -2.698586    1.086750     3
    84  Ar    -6.342976   -4.139976    2.996463     3
    85  Ar     5.469685   -5.317664   -1.859195     3
    86  Ar     7.008800   -2.521248   -1.500677     3
    87  Ar    -2.423491    5.599056    8.180287     3
    88  Ar     1.489761    4.699758   -9.498303     3
    89  Ar    -0.514446    3.122941    7.507910     3
    90  Ar     7.659125   -4.606474    3.580883     3
    91  Ar     6.241211   -2.434945    1.577266     3
    92  Ar     9.925383   -1.920396   -0.105615     3
    93  Ar     8.680916   -1.471393    3.066483     3
    94  Ar     7.579268    0.132229    0.285109     3
    95  Ar   -10.447009   -4.448028   -1.387191     3
    96  Ar     8.322729   -4.641406    0.319286     3
    97  Ar     5.402857   -5.371134    1.285685     3
    98  Ar     2.759784   -6.712454    2.588634     3
    99  Ar     5.463622   -5.898792   -4.934249     3
   100  Ar     1.128188   -8.732978    1.034798     3
   101  Ar     3.811174    8.925104   -1.185583     3
   102  Ar    -1.874414   -8.465982    0.394184     3
   103  Ar    -2.216198   -1.996929   -3.700186     3
   104  Ar     5.376424    9.357106    1.559219     3
   105  Ar    -7.416318   -4.660230   -2.860575     3
   106  Ar    -5.049438   -3.161356   -4.945063     3
   107  Ar    -6.008192   -0.608865   -3.784503     3
   108  Ar    -7.198781   -0.992274   -6.748874     3
   109  Ar    -1.032282   -1.220499  -10.731627     3
   110  Ar    -0.247677    1.446984   -9.450756     3
   111  Ar     0.592888   -3.500146   -8.543835     3
   112  Ar    -1.965824   -3.434926   -6.304796     3
   113  Ar     0.849411    1.027216    9.524551     3
   114  Ar    -3.277668    0.904292   -4.023087     3
   115  Ar     5.676484   -0.025803   -2.588841     3
   116  Ar     4.016320   -2.860636   -3.122472     3
   117  Ar     7.226961   -1.513092   -7.608467     3
   118  Ar     3.927033   -1.900407   -0.259705     3
   119  Ar     4.301574   -2.315397   -8.487235     3
   120  Ar     2.172691   -0.391612   -7.106611     3
   121  Ar     0.452808   -3.573665    9.987817     3
   122  Ar     8.068518    1.865840   -2.432441     3
   123  Ar    -2.218169   -3.716473    7.984994     3
   124  Ar     5.933866    6.303615   -0.158494     3
   125  Ar     1.824104   -6.923501    5.841072     3
   126  Ar     8.959873    5.567181   -0.223238     3
   127  Ar     3.725275   -7.521460   -0.362706     3
   128  Ar     2.385538   -5.489299   -3.362649     3
   129  Ar    -3.814215   -0.913716    7.020857     3
   130  Ar    -4.511681    1.167778    1.165026     3
   131  Ar     0.493495   -5.308686   -6.031917     3
   132  Ar    -5.495596    3.402569    3.087791     3
   133  Ar    -5.035413    5.704070   -2.167375     3
   134  Ar    -1.682217   -0.434596    0.998389     3
   135  Ar    -1.212588    2.605595    0.130756     3
   136  Ar    -6.441047    4.010011   -0.075021     3
   137  Ar    -3.580381    4.548412    1.052014     3
   138  Ar    -6.754757   -0.864627    1.800634     3
   139  Ar     2.810116    1.816773   -9.965401     3
   140  Ar    -4.153677   -4.161609   -2.188649     3
   141  Ar    -3.288249   -5.676485    0.369767     3
   142  Ar    -6.389939   -5.423011    0.145178     3
   143  Ar    -5.060335   -8.340692    0.412100     3
   144  Ar     2.253148    3.882740    9.608417     3
   145  Ar    -3.311767    0.634012   -9.423429     3
   146  Ar     1.821051    3.919633   -4.175845     3
   147  Ar    -0.860198   -0.858570   -7.470020     3
   148  Ar    -0.918230    4.851808   -5.681385     3
   149  Ar    -1.068825    3.255008   -3.010423     3
   150  Ar    -1.466212    4.148240   -8.604021     3
   151  Ar    -1.786424    0.926331    5.797525     3
   152  Ar    -2.544646    4.485417    5.179190     3
   153  Ar     4.196835   -8.146575   -3.282541     3
   154  Ar    -3.728956    2.852549    7.598534     3
   155  Ar     3.319609   -3.758978   -5.974018     3
   156  Ar     6.800399   -3.228577   -4.554975     3
   157  Ar    -6.050834   -1.689462    4.733653     3
   158  Ar    -9.028358   -0.568796   -0.445696     3
   159  Ar    -0.624150    8.021099   -5.557614     3
   160  Ar     8.605933    1.723803    3.070210     3
   161  Ar    -7.994779    0.781718    4.314936     3
   162  Ar    -9.228071    2.371549   -1.326199     3
   163  Ar     1.437675    2.392379    1.769052     3
   164  Ar    -2.358211    2.212172    3.022998     3
   165  Ar    -4.424936    7.589311    0.301384     3
   166  Ar    -3.839137    2.732319   -1.574037     3
   167  Ar    -0.928392    5.146302    2.582446     3
   168  Ar    -2.037900    5.739882   -1.220636     3
   169  Ar    -3.797303   -0.693936   -1.334319     3
   170  Ar     2.520365   -1.585768    8.424913     3
   171  Ar    -8.633309    0.978174   -3.995258     3
   172  Ar     3.796539   -3.958464    6.809906     3
   173  Ar    -3.139554    6.902923   -4.238480     3
   174  Ar     5.772780   -2.066170    8.288972     3
   175  Ar    -9.049368   -2.033628    3.741388     3
   176  Ar     0.912688    8.011379   -0.630776     3
   177  Ar    -3.884744   -3.778111    5.094769     3
   178  Ar     3.211057    5.733152   -1.908548     3
   179  Ar     1.871634    5.811001   -6.669421     3
   180  Ar     0.220464    6.342827   -3.116016     3
   181  Ar     4.710354   -0.552679   10.795874     3
   182  Ar    -6.496370    3.216703   -3.345002     3
   183  Ar     1.389420    0.676319    6.342042     3
   184  Ar    -8.533276    5.159662   -2.126936     3
   185  Ar    -1.763659   -5.928435    5.641561     3
   186  Ar     0.752952   -4.692729    3.902520     3
   187  Ar     3.669013    1.811214   -5.317716     3
   188  Ar     2.593912   -0.029525   -2.975702     3
   189  Ar     1.662274    2.565675   -1.445718     3
   190  Ar     6.660330    2.543803   -5.111627     3
   191  Ar     4.676864    5.053965   -5.064846     3
   192  Ar     4.102637    3.715954   -7.896109     3
   193  Ar     3.264382    7.052721    1.247999     3
   194  Ar     3.131939   -0.577113    2.600117     3
   195  Ar     4.497771    1.089461    0.305575     3
   196  Ar     6.879911    3.243892    0.063766     3
   197  Ar     3.467138    2.081091    4.137066     3
   198  Ar     5.973608    0.264693    3.235929     3
   199  Ar    10.668723    0.172814    4.997797     3
   200  Ar     0.788043   -2.268187   -4.931636     3
   201  Ar    -2.011296   -6.057236   -8.101048     3
   202  Ar     0.535454   -8.000290   -7.725660     3
   203  Ar    10.558692    0.237429   -2.395234     3
   204  Ar    -7.367845    7.282304   -0.352478     3
   205  Ar     1.878303   -1.153286  -10.145845     3
   206  Ar    -2.753506   -3.070106   -9.170344     3
   207  Ar    -3.958784   -0.796725   -6.657623     3
   208  Ar    -3.728951    3.906616   -4.707973     3
   209  Ar    -4.986122    1.371759    5.190079     3
   210  Ar     5.734930    6.603129    3.112432     3
   211  Ar     2.347399  -10.130486   -1.377561     3
   212  Ar    -1.599916    7.915454    1.228007     3
   213  Ar    -0.686963   10.700961    2.757313     3
   214  Ar     0.460849    9.822268    5.406630     3
   215  Ar     0.912467    7.829541    2.962234     3
   216  Ar    -1.651634    7.544497    4.574398     3)**";
   const char* pname = "amoeba09.prm";
   const char* p0 = commit_6fe8e913::amoeba09_prm;


   const double eps_e = 0.0001;
   const double eps_g = 0.0002;
   const double eps_v = 0.001;
   const char* argv[] = {"dummy", xname};
   int argc = 2;


   TestFile fxy(xname, x0);
   TestFile fke(kname, k0);
   TestFile fpr(pname, p0);


   TestReference r(TINKER9_DIRSTR "/src/test/truncated8.1.txt");
   auto ref_e = r.get_energy();
   auto ref_v = r.get_virial();
   auto ref_count = r.get_count();
   auto ref_g = r.get_gradient();


   test_begin_with_args(argc, argv);
   initialize();


   energy(calc::v0);
   COMPARE_REALS(esum, ref_e, eps_e);


   energy(calc::v1);
   COMPARE_REALS(esum, ref_e, eps_e);
   COMPARE_GRADIENT(ref_g, eps_g);
   for (int i = 0; i < 3; ++i)
      for (int j = 0; j < 3; ++j)
         COMPARE_REALS(vir[i * 3 + j], ref_v[i][j], eps_v);


   energy(calc::v3);
   COMPARE_REALS(esum, ref_e, eps_e);
   COMPARE_INTS(count_reduce(nev), ref_count);


   energy(calc::v4);
   COMPARE_REALS(esum, ref_e, eps_e);
   COMPARE_GRADIENT(ref_g, eps_g);


   energy(calc::v5);
   COMPARE_GRADIENT(ref_g, eps_g);


   energy(calc::v6);
   COMPARE_GRADIENT(ref_g, eps_g);
   for (int i = 0; i < 3; ++i)
      for (int j = 0; j < 3; ++j)
         COMPARE_REALS(vir[i * 3 + j], ref_v[i][j], eps_v);


   finish();
   test_end();
}
