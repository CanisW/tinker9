#include "files.h"
#include "test/ff.h"
#include "test/rt.h"
#include "test/test.h"

using namespace TINKER_NAMESPACE;
using namespace test;

static const char* bondterm_only = R"**(
bondterm  only
)**";

static int usage = gpu::use_xyz | gpu::vmask;

static const double ref_g_bond_trpcage[][3] = {
    {-4.5478, -0.0994, -10.7646},  {2.3617, 9.7931, -0.5016},
    {2.5556, 0.2252, 1.3678},      {3.0301, -1.8204, -2.6647},
    {1.8472, -1.3216, -0.4986},    {-0.2682, -1.7420, 1.0253},
    {3.0199, 1.6712, 1.2534},      {-1.0021, 2.1426, 0.3946},
    {-8.6932, -8.1766, 2.3866},    {5.7283, -6.3399, 3.9495},
    {-2.3749, 2.5034, -1.0158},    {-1.7802, 2.7891, 1.8136},
    {0.4779, -2.0906, -0.9501},    {-1.1018, 0.1422, -0.1004},
    {-0.4760, 0.4436, -0.1944},    {0.4234, -0.0052, 1.2989},
    {-11.4327, -0.4046, -5.6423},  {7.6125, -9.6926, -1.7365},
    {5.8374, -3.0164, 8.6018},     {-10.4811, 2.5574, 4.1019},
    {-2.1004, 0.9720, 1.7297},     {2.3793, -3.0200, -1.1637},
    {-11.5783, 9.4225, -9.3852},   {10.6194, -8.6233, 4.7477},
    {7.7095, 6.9580, -9.4574},     {-2.1479, 6.6968, 13.4207},
    {-1.5731, 1.8490, 0.6140},     {0.2007, 0.1040, -3.6815},
    {1.7788, -3.2572, 0.7088},     {0.9816, 0.2127, 0.3773},
    {-0.4682, 0.9989, -0.2900},    {0.1212, -0.4790, -0.7672},
    {1.0169, 0.1561, 0.4501},      {0.6408, 0.5214, -0.8257},
    {-0.3725, 0.8486, -0.1365},    {-0.3745, 1.1790, -10.5010},
    {-6.1659, 6.8422, 3.9219},     {5.3216, 2.2711, 6.2435},
    {6.9426, -1.1493, -5.6923},    {2.4921, -0.4417, -1.0719},
    {-2.4135, 2.6455, 1.6721},     {-4.2836, -9.2926, -7.9700},
    {-1.6925, 0.4713, -1.5874},    {-8.7182, 5.1057, 1.4851},
    {10.2467, -5.8813, -1.5367},   {-5.7231, 2.9683, 3.9672},
    {6.4332, -4.0689, 1.6524},     {0.3569, -1.2233, 6.4010},
    {0.1370, -0.4433, 2.7713},     {1.0218, -1.2075, -0.9321},
    {-1.7910, -0.3012, -0.5652},   {-1.3577, 0.9346, -0.5628},
    {1.0486, -0.4726, -0.8951},    {-0.6919, 0.3484, 0.6296},
    {0.8082, -0.5195, 0.3485},     {0.0360, -0.0244, 0.0121},
    {-9.5644, -1.8136, -3.3268},   {3.1252, -14.8870, -1.5769},
    {-0.0576, -1.0089, 10.9461},   {-5.8520, 0.6526, 2.4097},
    {-1.4409, 0.1011, 1.1414},     {2.9368, -2.9361, -1.1551},
    {0.9242, 7.7621, -11.4218},    {11.2026, -0.9900, 7.8315},
    {-10.0928, 11.4496, 3.2500},   {2.5237, 6.2017, -3.2207},
    {0.2355, -0.1520, -6.0436},    {1.6396, -2.2501, -0.4219},
    {-0.0337, 0.3324, 2.2590},     {0.4105, 0.0755, 0.1515},
    {-0.1025, -0.3356, 0.1351},    {-0.0452, 0.0556, 0.6356},
    {1.0579, 0.1255, 0.3727},      {-0.0173, 0.0313, 0.0065},
    {0.0348, -0.0844, -0.7023},    {1.7010, 1.1060, -10.6127},
    {-5.1991, 8.6094, 4.2165},     {5.5937, 1.3182, 4.6953},
    {7.0631, -0.9173, -5.9784},    {1.6432, -0.1113, -0.7432},
    {-2.4228, 2.8312, 1.7922},     {-4.0055, -12.0594, -3.4384},
    {3.9069, 3.7968, 5.3839},      {-6.7596, -2.5929, 8.0018},
    {1.9459, 0.1005, -2.6221},     {0.6842, -4.3641, -3.0885},
    {0.7725, -1.0228, -0.8603},    {-2.8010, -0.1405, -0.8578},
    {-0.5235, 0.9368, 0.7503},     {1.0182, -0.1020, 0.3245},
    {0.2214, 0.0033, -0.2531},     {-0.0880, -0.1615, 0.0489},
    {-10.4933, -1.7669, -1.3810},  {7.3004, -6.6475, -2.8915},
    {-0.4608, -1.0123, 7.5278},    {-6.0205, 0.0837, 3.0933},
    {-1.3746, 0.0650, 1.1722},     {3.0349, -2.5739, -1.5725},
    {-3.2764, 11.2061, -5.1238},   {1.0087, 7.9648, 13.1436},
    {-7.1452, -9.9728, -14.5635},  {14.7164, -4.1974, -10.6653},
    {16.7519, 6.3236, 6.9284},     {-14.3745, 0.8458, 4.5007},
    {-9.0063, -7.7341, -10.6354},  {8.1015, -7.0105, -13.3818},
    {-12.8754, 4.8214, 11.7327},   {9.5119, 8.7761, 11.5209},
    {-0.9701, 0.7864, 0.4547},     {0.0234, 0.2353, -1.7941},
    {0.3525, -0.7316, -1.2746},    {0.8754, 0.0126, -0.1599},
    {-3.4867, -0.6740, -0.2319},   {3.9732, 0.7491, 0.2249},
    {-2.4368, 1.3417, 2.7990},     {1.4338, 2.1523, 3.1800},
    {2.4362, 2.0807, -12.0905},    {-5.8313, 9.3783, 7.6515},
    {7.0584, 0.8721, 1.1884},      {5.7825, -0.8727, -5.6498},
    {1.3142, 0.0780, -0.7471},     {-2.0675, 2.2096, 1.9014},
    {-2.5429, -10.0259, -13.9055}, {-0.5152, 8.1206, 11.0558},
    {-10.9090, -9.4276, 2.3550},   {13.6122, -4.9193, 2.9454},
    {1.1188, -1.1833, -1.0925},    {-3.4939, -0.4266, -1.3806},
    {-0.5143, 2.8897, 2.2126},     {-0.0230, -0.3535, 1.0731},
    {0.0850, -0.9625, -0.6802},    {-0.9832, 0.4533, -0.1977},
    {0.0285, -0.2650, 0.9779},     {-0.8270, -0.6127, 0.1623},
    {0.1667, -0.9360, -0.5987},    {-11.8085, -1.2045, 0.9291},
    {7.9096, -10.3621, -1.9497},   {-1.3880, 0.6938, 9.2287},
    {-5.3890, 2.1874, 3.0924},     {-1.3994, 0.2309, 1.2905},
    {2.4755, -2.7795, -1.1776},    {-5.1714, 10.8238, -7.4082},
    {10.9857, -4.0537, -4.4754},   {-10.7940, 4.6281, 2.6658},
    {11.9617, 2.3048, -2.1952},    {1.4410, 8.3192, 7.6040},
    {-1.6045, 1.4352, 0.3661},     {0.1118, -0.4113, -3.9472},
    {1.1710, 1.0739, -2.0265},     {1.0128, -1.2515, 0.4903},
    {-1.7992, -1.1492, 2.1195},    {-1.2291, 2.0912, -0.8973},
    {0.3356, 0.5549, -0.3957},     {1.3370, -1.6537, 0.0239},
    {-1.9774, -0.4796, -1.0738},   {-1.8365, -3.6615, 2.3020},
    {1.2844, -1.5495, -0.2396},    {4.0374, -0.7340, -14.9978},
    {-9.6962, -6.7586, 5.0606},    {-3.5872, -1.6677, 20.5456},
    {8.2569, 19.1221, -13.5370},   {0.3289, -0.1217, -0.2208},
    {-4.7546, -1.6293, 2.0071},    {9.5293, -8.3885, -2.2534},
    {15.8991, -5.1937, 3.3500},    {-7.1766, 1.7880, -2.4292},
    {-7.7672, 1.7104, 6.1573},     {1.6662, 0.5600, -0.6844},
    {-0.4986, -1.9239, -1.0519},   {-0.0825, 0.5700, -2.1090},
    {-4.9408, 6.6291, -10.8611},   {2.4201, 0.1904, 5.7944},
    {0.1384, 5.3844, 5.8898},      {-0.9157, -2.9854, 1.6437},
    {-0.0350, -0.0317, 0.0215},    {0.3283, -0.2340, -0.0778},
    {1.0757, -4.9241, -0.6627},    {-9.5092, -6.2792, 1.7808},
    {5.6413, 0.5988, -10.9377},    {3.4641, 0.6404, -2.8629},
    {-0.0725, -2.5218, -2.6553},   {0.7279, -0.0088, -0.7029},
    {0.2743, -1.1819, -0.1576},    {-2.9878, -5.1511, 2.1985},
    {8.3756, 6.9914, -2.2520},     {3.4887, -9.3173, -0.6014},
    {-0.3389, -1.2627, 0.0237},    {1.8068, 4.2436, -2.4951},
    {-0.6333, 4.0725, 10.6231},    {-0.6703, 2.2471, 3.9171},
    {-10.3614, 1.4294, 5.6234},    {0.1544, 0.1405, 0.1056},
    {-0.2063, -2.7188, 1.7561},    {0.1968, 2.0074, -0.8029},
    {0.0610, -0.0073, -0.0984},    {-2.0124, 1.3741, -1.5226},
    {-0.8327, -1.5101, 0.8545},    {-5.0660, 8.5177, -0.6847},
    {-3.6653, -8.7140, 3.1700},    {6.4591, 1.5316, 2.9684},
    {-0.8281, 10.5011, 1.0879},    {0.1534, 0.6876, 0.0502},
    {-0.8156, -2.8080, 2.1827},    {0.9147, -0.0191, -10.3156},
    {3.6477, -2.9470, 2.4550},     {0.3479, 0.7070, -0.5647},
    {-1.8128, -0.8934, -1.0572},   {0.1720, -1.0267, -1.8507},
    {-5.2958, -7.8200, -4.6215},   {3.0611, 9.2151, -6.2146},
    {6.6619, -5.4006, 0.5240},     {-0.6607, -7.3039, -3.1538},
    {0.2334, -1.7186, -0.4322},    {1.1940, 2.8443, -1.6794},
    {-8.4729, 0.9356, 11.2859},    {4.9800, 3.2334, 1.6207},
    {-0.2930, -1.1759, 0.8144},    {-1.1048, 0.6996, -0.0911},
    {-0.5605, 0.4169, 1.3301},     {0.0123, 4.1773, 1.6136},
    {-1.8315, -7.2211, -5.0981},   {2.5034, 3.6251, 2.5211},
    {-0.4066, 6.0658, 1.2010},     {0.0681, 1.9560, 0.9165},
    {-0.4577, -1.7712, 0.7583},    {0.7094, -0.2930, -1.5053},
    {-5.9343, -6.7687, -5.7962},   {5.2611, 13.2617, -10.6733},
    {-1.3300, -10.9817, -1.9764},  {-0.7784, -5.4879, -0.5777},
    {0.1833, -2.4666, -0.6093},    {0.6284, 2.6997, -0.6642},
    {-15.4168, -4.2332, 9.7107},   {10.5608, 11.3861, 2.2334},
    {-8.2769, -8.0350, 6.6935},    {4.2582, -1.8853, -2.1692},
    {-2.2579, -0.8238, -2.1748},   {10.5925, 0.2084, 5.3573},
    {-8.4975, 5.6907, 6.0117},     {-1.2393, -3.2718, 0.5120},
    {-3.0163, 2.2603, 0.3983},     {-0.2983, 1.6288, 0.6193},
    {0.9854, 0.0538, -0.4655},     {-0.1191, -1.6344, -0.6748},
    {0.6021, -0.0726, -0.4713},    {2.0002, -1.2402, -1.4463},
    {-0.0234, -0.0305, -0.0647},   {1.5748, -1.2095, -1.3412},
    {0.0478, 0.0699, 0.1574},      {0.7971, -0.1048, 0.2837},
    {-2.2485, 5.8769, 1.9051},     {6.1772, -7.8472, -10.6756},
    {0.2088, -1.3230, 3.4160},     {-4.6195, 5.2749, 10.3796},
    {0.2025, -1.6954, -2.5243},    {8.4326, 4.9370, 0.1379},
    {2.2678, 2.2613, -0.9816},     {-0.4178, 9.9488, -2.0774},
    {1.0805, -0.4658, -0.3866},    {0.4233, 0.9589, 2.7709},
    {0.1972, -0.6006, -2.2959},    {0.3503, 0.6201, 0.0892},
    {-0.6727, 0.4453, -0.8750},    {-0.2036, 1.0836, 1.4660},
    {2.7270, 4.4258, -6.0285},     {-10.1141, -7.6817, 7.0526},
    {12.6190, 10.8038, -4.0983},   {-0.8021, -0.7828, 0.2421},
    {-2.4406, -0.4461, 0.7094},    {2.7142, -8.0641, 0.1100},
    {0.1259, -3.6200, -2.1478},    {0.8391, -3.0924, -9.4313},
    {-0.1488, -0.6495, 0.4982},    {3.7218, 0.4316, -0.1493},
    {-2.2288, -0.7392, 0.1338},    {0.2123, -0.2780, -0.2475},
    {-1.1363, 0.2698, -1.0671},    {1.7790, 0.3647, -0.8745},
    {-2.9145, -3.8587, -0.0796},   {3.6132, 10.0363, 2.2614},
    {8.4509, -6.0314, -1.9582},    {0.0094, -0.0691, -0.0248},
    {0.1080, 3.6337, 0.1750},      {-3.7903, -2.1868, 9.9191},
    {-3.0446, 1.0858, 3.4751},     {-9.7872, -3.6841, -1.1157},
    {0.1693, 0.4308, 0.7047},      {1.0861, -3.2455, 0.5128},
    {-0.2504, 0.6308, 0.0571},     {-0.1998, -0.2114, 0.1938},
    {0.3458, -0.1389, 0.2235},     {0.0637, -2.0352, -0.1434},
    {-5.4797, 2.9049, 0.7147},     {-7.7222, -15.9098, 0.5515},
    {10.3687, 7.4687, 5.1410},     {-9.3770, 10.5435, 4.9255},
    {-0.0448, 0.1946, 0.0922},     {0.5366, -2.1575, 1.3973},
    {1.9023, -0.1766, -12.3154},   {1.0917, -5.5567, -5.8507},
    {-0.0676, 0.7711, -0.4528},    {-0.4055, -0.5887, -0.4457},
    {2.7690, 4.4865, 6.0807},      {8.6810, -0.0632, 1.0336}};

TEST_CASE("Bond-Trpcage", "[ff][ebond][harmonic][trpcage]") {
  const char* k = "test_trpcage.key";
  const char* x1 = "test_trpcage.xyz";
  const char* p = "amoebapro13.prm";

  std::string k0 = trpcage_key;
  k0 += bondterm_only;
  file fke(k, k0);

  file fx1(x1, trpcage_xyz);
  file fpr(p, amoebapro13_prm);

  const char* argv[] = {"dummy", x1};
  int argc = 2;
  test_begin_1_xyz(argc, argv);
  gpu::use_data = usage;
  tinker_gpu_data_create();

  const double eps_e = 0.0001;
  const double ref_e = 19.4715;
  const int ref_count = 310;
  const double eps_g = test_get_eps2(0.004, 0.0001);
  const double eps_v = test_get_eps2(0.006, 0.001);
  const double ref_v[][3] = {{999.440, 47.686, 44.572},
                             {47.686, 792.043, 59.777},
                             {44.572, 59.777, 1049.659}};

  COMPARE_BONED_FORCE(gpu::ebond, gpu::eb, ref_e, eps_e, gpu::nbond, ref_count,
                      gpu::gx, gpu::gy, gpu::gz, ref_g_bond_trpcage, eps_g,
                      gpu::vir_eb, ref_v, eps_v);

  tinker_gpu_data_destroy();
  test_end();
}
